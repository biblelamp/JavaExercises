Apache Ant – быстрый старт

Apache Ant должен быть знаком каждому Java-программисту: это популярный инструмент сборки ПО (build tool), полностью написанный на Java. Сценарий сборки представляет собой простой XML-файл. Несмотря на свою Java-направленность, этим инструментом пользуются и другие разработчики.

Мы пройдём пять простых шагов, чтобы начать использовать Ant:
1. Скачаем, установим и настроим.
2. Разберёмся с принципами работы и форматом XML-сценария сборки.
3. Узнаем минимально необходимый список команд.
4. Напишем простейший Ant-сценарий.
5. Напишем сценарий для полного цикла сборки и тестирования простого проекта.

Нам потребуется Java SE Development Kit (JDK, скачиваем по адресу http://www.oracle.com/technetwork/java/javase/downloads), ваш любимый текстовый редактор (для Windows рекомендую Notepad++) и минимальные навыки работы в командной строке. Сценарии сборки и примеры протестированы в Windows XP/7 и Linux - Xubuntu 12.04, CentOS 6.8.

1. Скачиваем, устанавливаем, настраиваем

Посещаем веб-сайт https://ant.apache.org/ заходим в раздел Download/Binary Distributions и скачиваем файл apache-ant-1.10.1-bin.zip (возможно сейчас есть уже более свежая версия). Содержимое архива копируем в любой каталог, например "C:\Program Files\Ant" (Windows). Затем добавляем путь к папке bin (C:\Program Files\Ant\bin) в системную переменную Path.

Проверяем работоспособность Ant, вызвав командную строку:

    C:\>ant -version
    Apache Ant(TM) version 1.10.1 compiled on February 2 2017

Если аналогичное сообщение получено - всё в порядке.

2. Основные принципы работы

Сценарий сборки - обычный XML-файл. Он содержит определение целей (target), зависимостей (depends) и свойств (property). Простейший сценарий должен иметь хотя бы одну цель. Цель содержит вызов одной или нескольких команд или заданий (tasks). Мы можем задать имя цели с помощью атрибута "name". Заданное имя становится командой нашего сценария и может быть вызвана:

    C:\>ant <name>

В теге target может быть также указана зависимость (необязательно) с помощью атрибута "depends". Зависимости связывают цели между собой. Например, есть цель "compile", a есть "run", зависимая от "compile". И если мы выполняем "run", сначала выполняется "compile".

3. Минимально необходимый список заданий (tasks)

Стандартная версия Ant содержит более 150 заданий (https://ant.apache.org/manual/tasklist.html). Нам пока что потребуются семь:

    echo - вывод сообщения в консоль
    mkdir - создание директорий
    delete - удаление файлов и директорий
    javac - компиляция Java-кода
    java - запуск class и jar файлов
    junit - запуск тестов
    jar - создание jar файла

4. Простейший Ant-сценарий

    <?xml version="1.0"?>
    <project name="HelloWorld" default="hello">
        <target name="hello">
            <echo>Hello, World!</echo>
        </target>
    </project>

    В этом сценарии у нас единственная цель с именем hello - вывести строку в консоль. Обратите внимание: в теге project мы задали имя проекта, с помощью атрибута name и цель по умолчанию, с помощью атрибута default.
    Создадим каталог \Hello в корне диска D: () сохраним туда файл build.xml, содержащий предложенный выше сценарий. Запустим интерпретатор командной строки, перейдём в наш каталог и вызовем ant:

    D:\Hello>ant
    Buildfile: D:\Hello\build.xml

    hello:
         [echo] Hello, World!
    BUILD SUCCESSFULL

    Total time: 0 seconds

    Ant нашел файл сценария по умолчанию (build.xml), прочитал его и выполнил задание, заданное по умолчанию в теге project - hello. Мы получим аналогичный результат, если при вызове ant укажем в качестве параметра для него цель hello:

    D:\Hello>ant hello

5. Пишем сценарий для сборки и тестирования простого проекта

    Ant предоставляет полную свободу в формировании структуры каталогов проекта. Мы создадим папку src для исходных текстов на java. Это можно сделать в командной строке:

    D:\Hello>md src

    В папке D:\Hello\src мы сохраним файл HelloWorld.java следующего содержания:

    public class HelloWorld {
        public static void main(String[] args) {
            System.out.println("Hello, World!");
        }
    }

    Исправим предыдущий сценарий до следующего состояния:

    <?xml version="1.0"?>
    <project name="HelloWorld" default="run">
        <target name="mkdir">
            <mkdir dir="build/classes"/>
        </target>
        <target name="compile" depends="mkdir">
            <javac destdir="build/classes" includeantruntime="false">
                <src path="src"/>
            </javac>
        </target>
        <target name="run" depends="compile">
            <java classname="HelloWorld" classpath="build/classes"/>
        </target>
        <target name="clean">
            <delete dir="build"/>
        </target>
    </project>

    Наш сценарий содержит четыре цели (команды): mkdir (создание папок для классов), compile (компиляция файла(ов) .java), run (запуск файла(ов) .class), clean (удаление папок с результатами компиляции).

    Сценарий для проекта, вторая версия (используем property):

    <?xml version="1.0"?>
    <project name="HelloWorld" default="run">
        <property name="src" location="src"/>
        <property name="build" location="build"/>
        <property name="classes" location="${build}/classes"/>
        <target name="mkdir">
            <mkdir dir="${classes}"/>
        </target>
        <target name="compile" depends="mkdir">
            <javac srcdir="${src}" destdir="${classes}" includeAntRuntime="false"/>
        </target>
        <target name="run" depends="compile">
            <java classname="${ant.project.name}" classpath="${classes}"/>
        </target>
        <target name="clean">
            <delete dir="${build}"/>
        </target>
    </project>

    Немного изменим код проекта (чтобы было что тестировать):

    public class HelloWorld {
        public static void main(String[] args) {
            HelloWorld hello = new HelloWorld();
            System.out.println(hello.sayHello());
        }
        String sayHello() {
            return "Hello, World!";
        }
    }

    и добавим в папку src файл/класс с простым тестом:

    import static org.junit.Assert.assertEquals;
    import org.junit.Test;
    public class TestHello {
        @Test
        public void testHello() {
            HelloWorld hello = new HelloWorld();
            assertEquals("Hello, World!", hello.sayHello());
        }
    }

    Используя информацию со страницы https://github.com/junit-team/junit4/wiki/getting-started загрузим два файла junit-4.12.jar и hamcrest-core-1.3.jar и скопируем их в папку нашего <JDK>\jre\lib\ext. Теперь мы можем проверить как работает тестирование в командной строке:

    C:\>java org.junit.runner.JUnitCore TestHello
    JUnit version 4.12
    .
    Time: 0,11
    OK (1 test)

    Теперь дополним наш build файл следующими строчками:

    <target name="test" depends="compile">
        <junit>
            <classpath>
                <pathelement location="${classes}"/>
            </classpath>
            <test name="TestHello"/>
        </junit>
    </target>

    и дополним строку с заданием jar:

    <jar destfile="${build}/${ant.project.name}.jar" basedir="${classes}" excludes="Test*.class">

    Теперь к списку команд нашего build файла добавилась команда test.
    Осталось добавить target для сборки, которая сформирует jar файл:

    <target name="package" depends="compile">
        <jar destfile="${build}/${ant.project.name}.jar" basedir="${classes}" excludes="Test*.class">
            <manifest>
                <attribute name="Main-Class" value="${ant.project.name}"/>
            </manifest>
        </jar>
    </target>
